@startuml
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml

title Smart Home Container Diagram

top to bottom direction

Person(user, "User", "Пользователь Smart Home")
System(SmartHomeSystem, "Система Smart Home")

Container_Boundary(SmartHomeSystem, "Smart Home System") {
  Container(UI, "SmartHome UI", "React", "Фронтенд-приложение")
  Container(APIGateway, "API Gateway", "Kong", "API Gateway")
  Container(UserManagment, "User Managment Service", "Java, Spring Boot", "Авторизация и управления пользователями")
  Container(DeviceManagement, "Device Management Service", "Java, Spring Boot", "Конфигурирование устройств")
  Container(DeviceControl, "Device Control Service", "Java, Spring Boot", "Управление устройствами")
  Container(DataCollector, "DataCollector Service", "Java, Spring Boot", "Коллектор сбора данных с датчиков")
  ContainerDb(UserManagmentDb, "Database User Managment", "PostgreSQL", "База данных сервиса авторизация и управления пользователями")
  ContainerDb(DeviceManagementDb, "Database Device Management", "PostgreSQL", "База данных конфигурации устройств")
  ContainerDb(DatabaseTelemetry, "Database Telemetry", "ClickHouse", "База данных телеметрии")
  ContainerQueue(EventBus, "Event bus", "Apache Kafka", "Шина данных событий")
  ContainerQueue(DataBus, "Sensor data bus", "NATS", "Шина данных датчиков")
}

System_Ext(devices, "Devices", "Внешние устройства")
System_Ext(sensors, "Sensors", "Внешние датчики")

Rel(user, UI, "Использует фронтенд-приложение для взаимодействия с системой")

Rel(UI, APIGateway, "Через шлюз использует микросервисы для получения данных")

Rel(APIGateway, UserManagment, "Авторизация и управление пользователями")
Rel(APIGateway, DeviceManagement, "Управление конфигурациями устройств")
Rel(APIGateway, DeviceControl, "Управление и контроль устройств")
Rel(APIGateway, DataCollector, "Мониторинг датчиков")

Rel(UserManagment, UserManagmentDb, "Чтение/запись агрегатов, сущностей, объектов значений")

Rel(DeviceManagement, DeviceManagementDb, "Чтение/запись агрегатов, сущностей, объектов значений")
Rel(DeviceManagement, EventBus, "Публикация/подписка на доменные события")

Rel(DeviceControl, EventBus, "Публикация/подписка на доменные события")


Rel(DataCollector, DatabaseTelemetry, "Чтение/запись данных телеметрии")
Rel(DataCollector, EventBus, "Публикация/подписка на доменные события")
Rel(DataCollector, DataBus, "Push-подписка на данные телеметрии")

Rel_D(devices, EventBus, "Подписка на события управления и обновление конфигурации")
Rel(DataBus, DataCollector, "Push данных телеметрии")
Rel_D(sensors, DataBus, "Отправка данных телеметрии")
@enduml